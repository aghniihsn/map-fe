<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Map Your Memories</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; }

        #input-form {
            display: none; 
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: white; padding: 20px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            z-index: 2000; border-radius: 8px; width: 300px;
        }
        #input-form input, #input-form select, #input-form textarea {
            width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box;
        }
        #input-form button {
            width: 100%; padding: 10px; cursor: pointer;
            background: #28a745; color: white; border: none; border-radius: 8px;
        }
        #input-form .cancel-btn {
            background: #dc3545; margin-top: 5px; border-radius: 8px;
        }
        
        .btn-delete {
            background: red; color: white; border: none; 
            padding: 5px 10px; cursor: pointer; border-radius: 6px; font-size: 12px;
        }
        .form-control {
            padding: 8px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <div id="input-form">
        <h3>Tambah Lokasi</h3>
        <input class="form-control" type="text" id="input-nama" placeholder="Nama Tempat">
        <textarea class="form-control" id="input-desc" placeholder="Deskripsi Singkat"></textarea>
        <select class="form-control" id="input-kategori">
            <option value="umum">ðŸ”µ Umum</option>
            <option value="kuliner">ðŸ”´ Kuliner</option>
            <option value="wisata">ðŸŸ¢ Wisata</option>
        </select>
        <input type="hidden" id="input-lat">
        <input type="hidden" id="input-lng">
        <button onclick="simpanLokasi()">Simpan</button>
        <button class="cancel-btn" onclick="tutupForm()">Batal</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_URL = 'https://map-be.onrender.com/api/locations';

        const map = L.map('map').setView([-6.2088, 106.8456], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(map);

        const icons = {
            umum: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            kuliner: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            wisata: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] })
        };

        async function loadMarkers() {
            try {
                const res = await fetch(API_URL);
                const data = await res.json();
                
                map.eachLayer((layer) => {
                    if (layer instanceof L.Marker) map.removeLayer(layer);
                });

                data.forEach(loc => {
                    const iconDipakai = icons[loc.kategori] || icons['umum'];

                    const marker = L.marker([loc.latitude, loc.longitude], { icon: iconDipakai }).addTo(map);
                    
                    marker.bindPopup(`
                        <b>${loc.nama}</b><br>
                        <i>${loc.kategori}</i><br>
                        ${loc.deskripsi || '-'}<br><br>
                        <button class="btn-delete" onclick="hapusLokasi('${loc._id}')">Hapus</button>
                    `);
                });
            } catch (err) { console.error(err); }
        }

        map.on('click', (e) => {
            document.getElementById('input-lat').value = e.latlng.lat;
            document.getElementById('input-lng').value = e.latlng.lng;
            
            document.getElementById('input-form').style.display = 'block';
            document.getElementById('input-nama').focus();
        });

        async function simpanLokasi() {
            const nama = document.getElementById('input-nama').value;
            const desc = document.getElementById('input-desc').value;
            const kat = document.getElementById('input-kategori').value;
            const lat = document.getElementById('input-lat').value;
            const lng = document.getElementById('input-lng').value;

            if (!nama) return alert("Nama wajib diisi!");

            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nama: nama,
                        deskripsi: desc,
                        kategori: kat,
                        latitude: lat,
                        longitude: lng
                    })
                });
                tutupForm();
                loadMarkers(); 
            } catch (err) { alert("Gagal simpan"); }
        }

        async function hapusLokasi(id) {
            if (confirm("Yakin mau hapus lokasi ini?")) {
                try {
                    await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                    loadMarkers(); 
                } catch (err) { alert("Gagal hapus"); }
            }
        }

        function tutupForm() {
            document.getElementById('input-form').style.display = 'none';
            document.getElementById('input-nama').value = '';
            document.getElementById('input-desc').value = '';
        }

        loadMarkers();
    </script>
</body>
</html>